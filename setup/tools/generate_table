#!/bin/bash

set -e

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <input_csv>"
    echo "Example: $0 ./out.csv"
    exit 1
fi

INPUT_CSV="$1"

if [ ! -f "$INPUT_CSV" ]; then
    echo "Error: File $INPUT_CSV does not exist"
    exit 1
fi

# Print table header
cat << 'EOF'
\begin{tabular}{l
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]
                S[table-format=1.2]}
\hline
\textbf{Workload} & \textbf{Baseline} & \multicolumn{2}{c}{\textbf{LLC}} & \multicolumn{2}{c}{\textbf{Mem Read}} & \multicolumn{2}{c}{\textbf{Mem Write}} & \multicolumn{2}{c}{\textbf{SysCall}} & \multicolumn{2}{c}{\textbf{Prefetch}} \\
                  & \textbf{IPC}      & \textbf{IPC} & \textbf{Sens.} & \textbf{IPC} & \textbf{Sens.} & \textbf{IPC} & \textbf{Sens.} & \textbf{IPC} & \textbf{Sens.} & \textbf{IPC} & \textbf{Sens.} \\
\hline
EOF

# Process each row
tail -n +2 "$INPUT_CSV" | while IFS=',' read -r benchmark baseline_ipc llc_stressed llc_sens memread_stressed memread_sens memwrite_stressed memwrite_sens syscall_stressed syscall_sens prefetch_stressed prefetch_sens; do
    
    # Format the benchmark name (replace underscores/hyphens with spaces, use texttt for monospace)
    workload_name=$(echo "$benchmark" | sed 's/_/\\_/g' | sed 's/-/\\-/g')
    
    # Calculate deltas (stressed  baseline, negative means degradation)
    llc_delta=$(echo "$llc_stressed - $baseline_ipc" | bc -l)
    memread_delta=$(echo "$memread_stressed - $baseline_ipc" | bc -l)
    memwrite_delta=$(echo "$memwrite_stressed - $baseline_ipc" | bc -l)
    syscall_delta=$(echo "$syscall_stressed - $baseline_ipc" | bc -l)
    prefetch_delta=$(echo "$prefetch_stressed - $baseline_ipc" | bc -l)
    
    # Format to 2 decimal places
    baseline_ipc=$(printf "%.2f" "$baseline_ipc")
    llc_stressed=$(printf "%.2f" "$llc_stressed")
    llc_sens=$(printf "%.2f" "$llc_sens")
    memread_stressed=$(printf "%.2f" "$memread_stressed")
    memread_sens=$(printf "%.2f" "$memread_sens")
    memwrite_stressed=$(printf "%.2f" "$memwrite_stressed")
    memwrite_sens=$(printf "%.2f" "$memwrite_sens")
    syscall_stressed=$(printf "%.2f" "$syscall_stressed")
    syscall_sens=$(printf "%.2f" "$syscall_sens")
    prefetch_stressed=$(printf "%.2f" "$prefetch_stressed")
    prefetch_sens=$(printf "%.2f" "$prefetch_sens")
    
    # Print table row
    echo "\\texttt{$workload_name} & $baseline_ipc & $llc_stressed & \\textbf{$llc_sens} & $memread_stressed & \\textbf{$memread_sens} & $memwrite_stressed & \\textbf{$memwrite_sens} & $syscall_stressed & \\textbf{$syscall_sens} & $prefetch_stressed & \\textbf{$prefetch_sens} \\\\"
done

# Print table footer
cat << 'EOF'
\hline
\end{tabular}
EOF
